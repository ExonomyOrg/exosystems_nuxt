name: Update Parent Issues on Comment

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  update-parent-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install GitHub CLI
        run: sudo apt-get install gh -y

      - name: Authenticate with GitHub CLI
        run: gh auth login --with-token <<< ${{ secrets.GITHUB_TOKEN }}

      - name: Update Parent Issues
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          REPO=${{ github.repository }}

          # Fetch the issue title and the body for processing
          TITLE=$(gh issue view $ISSUE_NUMBER --json title -q .title)
          BODY=$(gh issue view $ISSUE_NUMBER --json body -q .body)

          # Remove the "Parents:" line from the body
          CLEANED_BODY=$(echo "$BODY" | sed '/^Parents:/d')

          # Extract the first 100 characters of the cleaned body for a brief summary
          SUMMARY=$(echo "$CLEANED_BODY" | head -c 100)

          # Remove any line breaks or quotes from the summary
          SUMMARY=$(echo "$SUMMARY" | tr -d '\n' | tr -d '"')

          # Find the "Parents" line in the original body
          PARENTS_LINE=$(echo "$BODY" | grep -oP 'Parents:\s*#[0-9, ]+')
          if [ -z "$PARENTS_LINE" ]; then
            echo "No Parents found, exiting."
            exit 0
          fi

          # Extract parent issue numbers
          PARENT_IDS=$(echo "$PARENTS_LINE" | grep -oP '#\d+' | grep -oP '\d+')

          # Loop through each parent and update its description
          for PARENT_ID in $PARENT_IDS; do
            PARENT_DESCRIPTION=$(gh issue view $PARENT_ID --json body -q .body)
            NEW_ENTRY="Child: #$ISSUE_NUMBER - $TITLE - $SUMMARY..."

            # Append the new entry if it's not already there
            if ! echo "$PARENT_DESCRIPTION" | grep -q "$NEW_ENTRY"; then
              UPDATED_DESCRIPTION="${PARENT_DESCRIPTION}\n$NEW_ENTRY"
              UPDATED_DESCRIPTION=$(echo "$UPDATED_DESCRIPTION" | sed 's/\\n$//') # Remove trailing newline
              gh issue edit $PARENT_ID --body "$UPDATED_DESCRIPTION"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
